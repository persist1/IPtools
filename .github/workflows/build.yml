name: Build Multi-Platform

on:
  push:
    branches: [ main, master, develop ]
  pull_request:
    branches: [ main, master, develop ]
  workflow_dispatch:
    inputs:
      platform:
        description: 'é€‰æ‹©æž„å»ºå¹³å°'
        required: true
        default: 'all'
        type: choice
        options:
          - all
          - windows-x64
          - windows-x86
          - linux-x86_64
          - linux-arm64
          - macos-x86_64
          - macos-arm64

env:
  QT_VERSION: '5.15.2'

jobs:
  build-windows:
    name: Build Windows (${{ matrix.arch }})
    runs-on: windows-latest
    # åªåœ¨æ»¡è¶³ä»¥ä¸‹æ¡ä»¶æ—¶è¿è¡Œï¼š
    # 1. è‡ªåŠ¨è§¦å‘ï¼ˆpush/PRï¼‰æ—¶
    # 2. æ‰‹åŠ¨è§¦å‘ä¸”é€‰æ‹©äº† all æˆ–å¯¹åº”çš„å¹³å°
    if: |
      github.event_name != 'workflow_dispatch' || 
      github.event.inputs.platform == 'all' || 
      startsWith(github.event.inputs.platform, 'windows')
    strategy:
      fail-fast: false
      matrix:
        include:
          - arch: win64_mingw81
            mingw_arch: x86_64
            mingw_version: '8.1.0'
            mingw_dir: mingw810_64
            platform_name: windows-x64
          - arch: win32_mingw81
            mingw_arch: i686
            mingw_version: '8.1.0'
            mingw_dir: mingw810_32
            platform_name: windows-x86
    
    steps:
    - name: Checkout Code
      uses: actions/checkout@v4
    
    - name: Install Qt
      uses: jurplel/install-qt-action@v3
      with:
        version: ${{ env.QT_VERSION }}
        host: 'windows'
        target: 'desktop'
        arch: ${{ matrix.arch }}
        modules: 'qtnetworkauth'
        cache: true
    
    - name: Install MinGW ${{ matrix.mingw_version }}
      shell: pwsh
      run: |
        Write-Host "Downloading MinGW ${{ matrix.mingw_version }} from Qt official source..."
        
        # Qt å®˜æ–¹ MinGW 8.1.0 ä¸‹è½½åœ°å€
        $mingwUrl = "https://download.qt.io/online/qtsdkrepository/windows_x86/desktop/tools_mingw/${{ matrix.mingw_dir }}/"
        $archiveName = "${{ matrix.mingw_dir }}-gcc-8.1.0-1-any.7z"
        $downloadUrl = $mingwUrl + $archiveName
        $downloadPath = Join-Path $env:TEMP $archiveName
        $extractPath = "C:\Qt\Tools\${{ matrix.mingw_dir }}"
        
        try {
          Write-Host "Downloading from: $downloadUrl"
          Invoke-WebRequest -Uri $downloadUrl -OutFile $downloadPath -UseBasicParsing
          
          Write-Host "Extracting to: $extractPath"
          New-Item -ItemType Directory -Force -Path $extractPath | Out-Null
          7z x $downloadPath -o"$extractPath" -y
          
          Write-Host "MinGW ${{ matrix.mingw_version }} installed successfully"
        } catch {
          Write-Warning "Failed to download from Qt official source: $_"
          Write-Host "Falling back to Chocolatey MinGW..."
          choco install mingw -y --no-progress --force
        }
    
    - name: Setup Build Environment
      shell: pwsh
      run: |
        if (-not $env:Qt5_Dir) {
          throw "Qt5_Dir çŽ¯å¢ƒå˜é‡æœªè®¾ç½®"
        }

        Write-Host "Qt5_Dir: $env:Qt5_Dir"
        Write-Host ""

        # æ·»åŠ  Qt bin åˆ° PATH
        $qtBin = Join-Path $env:Qt5_Dir 'bin'
        if (Test-Path $qtBin) {
          Write-Host "Adding Qt bin: $qtBin"
          $qtBin | Out-File -FilePath $env:GITHUB_PATH -Encoding utf8 -Append
        }

        # æŸ¥æ‰¾å¹¶æ·»åŠ  MinGWï¼ˆä¼˜å…ˆä½¿ç”¨ Qt å®˜æ–¹ä¸Žå·²è§£åŽ‹è·¯å¾„ï¼‰
        $mingwPaths = @(
          "C:\Qt\Tools\${{ matrix.mingw_dir }}\mingw64\bin",
          "C:\Qt\Tools\${{ matrix.mingw_dir }}\mingw32\bin",
          "C:\Qt\Tools\${{ matrix.mingw_dir }}\bin",
          'C:\ProgramData\mingw64\mingw64\bin',
          'C:\ProgramData\mingw32\mingw32\bin',
          'C:\tools\mingw64\bin',
          'C:\tools\mingw32\bin'
        )
        
        $foundMinGW = $false
        foreach ($path in $mingwPaths) {
          if (Test-Path $path) {
            Write-Host "Found MinGW at: $path"
            $path | Out-File -FilePath $env:GITHUB_PATH -Encoding utf8 -Append
            
            # éªŒè¯ç¼–è¯‘å™¨ç‰ˆæœ¬
            $gccPath = Join-Path $path 'g++.exe'
            if (Test-Path $gccPath) {
              $gccVersion = & $gccPath --version 2>&1 | Select-Object -First 1
              Write-Host "GCC Version: $gccVersion"
            }
            
            # å¯¼å‡ºåˆ°çŽ¯å¢ƒï¼Œä¾¿äºŽåŽç»­æ­¥éª¤å°†å…¶ç½®äºŽ PATH å‰ç«¯
            "MINGW_BIN=$path" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append
            
            $foundMinGW = $true
            break
          }
        }
        
        if (-not $foundMinGW) {
          Write-Error "MinGW æœªæ‰¾åˆ°ï¼å°è¯•çš„è·¯å¾„ï¼š"
          $mingwPaths | ForEach-Object { Write-Error "  - $_" }
          throw "MinGW æœªæ‰¾åˆ°"
        }
        
        Write-Host ""
        Write-Host "=== çŽ¯å¢ƒé…ç½®å®Œæˆ ==="
    
    - name: Build Project
      shell: cmd
      run: |
        echo Building IPtools...
        set "PATH=%MINGW_BIN%;%PATH%"
        "%Qt5_Dir%\bin\qmake.exe" IPtools.pro CONFIG+=release
        "%MINGW_BIN%\mingw32-make.exe" -j4
    
    - name: Deploy Qt Dependencies
      shell: cmd
      run: |
        echo Using Qt from %Qt5_Dir%
        set "PATH=%MINGW_BIN%;%PATH%"
        where windeployqt
        set QT_PLUGIN_PATH=%Qt5_Dir%\plugins
        set QML2_IMPORT_PATH=%Qt5_Dir%\qml
        echo QT_PLUGIN_PATH=%QT_PLUGIN_PATH%
        dir "%Qt5_Dir%\plugins\platforms"
        cd release
        rem å…ˆéƒ¨ç½²æ ¸å¿ƒåº“ï¼Œè·³è¿‡æ’ä»¶æ£€æµ‹
        "%Qt5_Dir%\bin\windeployqt.exe" IPtools.exe --release --no-translations --compiler-runtime --no-plugins
        rem æ‰‹åŠ¨æ‹·è´å¹³å°æ’ä»¶ï¼Œç¡®ä¿ qwindows å­˜åœ¨
        if not exist platforms mkdir platforms
        copy "%Qt5_Dir%\plugins\platforms\qwindows.dll" platforms\ /Y
    
    - name: Create Archive
      shell: pwsh
      run: |
        $archName = "IPtools-Windows-${{ matrix.mingw_arch }}"
        New-Item -ItemType Directory -Force -Path dist
        Copy-Item -Path release/IPtools.exe -Destination dist/
        Copy-Item -Path README.md -Destination dist/ -ErrorAction SilentlyContinue
        Copy-Item -Path USAGE_GUIDE.md -Destination dist/ -ErrorAction SilentlyContinue
        Copy-Item -Path LICENSE -Destination dist/ -ErrorAction SilentlyContinue
        Copy-Item -Path release/*.dll -Destination dist/ -ErrorAction SilentlyContinue
        Compress-Archive -Path dist/* -DestinationPath "$archName.zip"
    
    - name: Upload Artifact
      uses: actions/upload-artifact@v4
      with:
        name: IPtools-Windows-${{ matrix.mingw_arch }}
        path: IPtools-Windows-${{ matrix.mingw_arch }}.zip
        retention-days: 30

  build-linux:
    name: Build Linux (${{ matrix.arch }})
    runs-on: ubuntu-20.04
    if: |
      github.event_name != 'workflow_dispatch' || 
      github.event.inputs.platform == 'all' || 
      startsWith(github.event.inputs.platform, 'linux')
    strategy:
      fail-fast: false
      matrix:
        include:
          - arch: x86_64
            qt_arch: gcc_64
            platform_name: linux-x86_64
          - arch: aarch64
            qt_arch: gcc_64
            platform_name: linux-arm64
    
    steps:
    - name: Checkout Code
      uses: actions/checkout@v4
    
    - name: Install Dependencies (x86_64)
      if: matrix.arch == 'x86_64'
      run: |
        sudo apt-get update
        sudo apt-get install -y qt5-default qtbase5-dev qttools5-dev-tools \
          build-essential lsof libgl1-mesa-dev
    
    - name: Install Cross-Compilation Tools (ARM64)
      if: matrix.arch == 'aarch64'
      run: |
        sudo apt-get update
        sudo apt-get install -y gcc-aarch64-linux-gnu g++-aarch64-linux-gnu \
          qt5-default qtbase5-dev qttools5-dev-tools build-essential
    
    - name: Build Project (x86_64)
      if: matrix.arch == 'x86_64'
      run: |
        qmake IPtools.pro CONFIG+=release
        make -j$(nproc)
    
    - name: Build Project (ARM64)
      if: matrix.arch == 'aarch64'
      run: |
        # Note: Full ARM64 cross-compilation requires ARM64 Qt libraries
        # This is a placeholder - actual cross-compilation needs proper Qt setup
        qmake IPtools.pro CONFIG+=release
        make -j$(nproc) CXX=aarch64-linux-gnu-g++ CC=aarch64-linux-gnu-gcc || echo "ARM64 cross-compilation requires ARM64 Qt libraries"
    
    - name: Create AppImage (x86_64)
      if: matrix.arch == 'x86_64'
      run: |
        sudo apt-get install -y libfuse2
        wget https://github.com/linuxdeploy/linuxdeploy/releases/download/continuous/linuxdeploy-x86_64.AppImage
        wget https://github.com/linuxdeploy/linuxdeploy-plugin-qt/releases/download/continuous/linuxdeploy-plugin-qt-x86_64.AppImage
        chmod +x linuxdeploy*.AppImage
        mkdir -p AppDir/usr/bin
        cp IPtools AppDir/usr/bin/
        cp README.md AppDir/usr/ || true
        ./linuxdeploy-x86_64.AppImage --appdir AppDir --plugin qt --output appimage || echo "AppImage creation failed, continuing..."
    
    - name: Create Archive
      run: |
        mkdir -p dist
        if [ -f "IPtools" ]; then
          cp IPtools dist/
        fi
        cp README.md dist/ || true
        cp USAGE_GUIDE.md dist/ || true
        cp LICENSE dist/ || true
        tar -czf IPtools-Linux-${{ matrix.arch }}.tar.gz -C dist .
    
    - name: Upload Artifact
      uses: actions/upload-artifact@v4
      with:
        name: IPtools-Linux-${{ matrix.arch }}
        path: |
          IPtools-Linux-${{ matrix.arch }}.tar.gz
          *.AppImage
        retention-days: 30

  build-macos:
    name: Build macOS (${{ matrix.arch }})
    runs-on: ${{ matrix.os }}
    if: |
      github.event_name != 'workflow_dispatch' || 
      github.event.inputs.platform == 'all' || 
      startsWith(github.event.inputs.platform, 'macos')
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: macos-12
            arch: x86_64
            platform_name: macos-x86_64
          - os: macos-14
            arch: arm64
            platform_name: macos-arm64
    
    steps:
    - name: Checkout Code
      uses: actions/checkout@v4
    
    - name: Install Qt
      uses: jurplel/install-qt-action@v3
      with:
        version: ${{ env.QT_VERSION }}
        host: 'mac'
        target: 'desktop'
        modules: 'qtnetworkauth'
        cache: true
    
    - name: Build Project
      run: |
        qmake IPtools.pro CONFIG+=release
        make -j$(sysctl -n hw.ncpu)
    
    - name: Create App Bundle
      run: |
        mkdir -p dist
        cp -r IPtools.app dist/
        macdeployqt dist/IPtools.app -dmg
        cp README.md dist/ || true
        cp USAGE_GUIDE.md dist/ || true
        cp LICENSE dist/ || true
    
    - name: Create Archive
      run: |
        cd dist
        if [ -f "IPtools.dmg" ]; then
          mv IPtools.dmg ../IPtools-macOS-${{ matrix.arch }}.dmg
        else
          tar -czf ../IPtools-macOS-${{ matrix.arch }}.tar.gz .
        fi
    
    - name: Upload Artifact
      uses: actions/upload-artifact@v4
      with:
        name: IPtools-macOS-${{ matrix.arch }}
        path: |
          IPtools-macOS-${{ matrix.arch }}.*
        retention-days: 30

  build-summary:
    name: Build Summary
    needs: [build-windows, build-linux, build-macos]
    runs-on: ubuntu-latest
    if: always()
    
    steps:
    - name: Summary
      run: |
        echo "## ðŸŽ¯ æž„å»ºç»“æžœ" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        # æ˜¾ç¤ºè§¦å‘æ–¹å¼
        if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
          echo "**è§¦å‘æ–¹å¼**: æ‰‹åŠ¨è§¦å‘" >> $GITHUB_STEP_SUMMARY
          echo "**é€‰æ‹©å¹³å°**: \`${{ github.event.inputs.platform }}\`" >> $GITHUB_STEP_SUMMARY
        else
          echo "**è§¦å‘æ–¹å¼**: è‡ªåŠ¨è§¦å‘ (${{ github.event_name }})" >> $GITHUB_STEP_SUMMARY
        fi
        echo "" >> $GITHUB_STEP_SUMMARY
        
        echo "| å¹³å° | æž¶æž„ | çŠ¶æ€ |" >> $GITHUB_STEP_SUMMARY
        echo "|------|------|------|" >> $GITHUB_STEP_SUMMARY
        echo "| ðŸªŸ Windows | x64 | ${{ needs.build-windows.result }} |" >> $GITHUB_STEP_SUMMARY
        echo "| ðŸªŸ Windows | x86 | ${{ needs.build-windows.result }} |" >> $GITHUB_STEP_SUMMARY
        echo "| ðŸ§ Linux | x86_64 | ${{ needs.build-linux.result }} |" >> $GITHUB_STEP_SUMMARY
        echo "| ðŸ§ Linux | ARM64 | ${{ needs.build-linux.result }} |" >> $GITHUB_STEP_SUMMARY
        echo "| ðŸŽ macOS | x86_64 | ${{ needs.build-macos.result }} |" >> $GITHUB_STEP_SUMMARY
        echo "| ðŸŽ macOS | ARM64 | ${{ needs.build-macos.result }} |" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "ðŸ“¦ æž„å»ºäº§ç‰©å¯åœ¨ Actions æ ‡ç­¾é¡µçš„ Artifacts ä¸­ä¸‹è½½ã€‚" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "â±ï¸ äº§ç‰©ä¿ç•™æ—¶é—´ï¼š30 å¤©" >> $GITHUB_STEP_SUMMARY

