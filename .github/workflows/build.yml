name: Build Multi-Platform

on:
  push:
    branches: [ main, master, develop ]
  pull_request:
    branches: [ main, master, develop ]
  workflow_dispatch:

env:
  QT_VERSION: '5.15.2'

jobs:
  build-windows:
    name: Build Windows (${{ matrix.arch }})
    runs-on: windows-latest
    strategy:
      fail-fast: false
      matrix:
        include:
          - arch: win64_mingw81
            mingw_arch: x86_64
            mingw_prefix: mingw64
          - arch: win32_mingw81
            mingw_arch: i686
            mingw_prefix: mingw32
    
    steps:
    - name: Checkout Code
      uses: actions/checkout@v4
    
    - name: Install Qt
      uses: jurplel/install-qt-action@v3
      with:
        version: ${{ env.QT_VERSION }}
        host: 'windows'
        target: 'desktop'
        arch: ${{ matrix.arch }}
        modules: 'qtnetworkauth'
        cache: true
    
    - name: Build Project
      shell: cmd
      run: |
        qmake IPtools.pro CONFIG+=release
        mingw32-make -j4
    
    - name: Deploy Qt Dependencies
      shell: cmd
      run: |
        cd release
        windeployqt IPtools.exe --release --no-translations
    
    - name: Create Archive
      shell: pwsh
      run: |
        $archName = "IPtools-Windows-${{ matrix.mingw_arch }}"
        New-Item -ItemType Directory -Force -Path dist
        Copy-Item -Path release/IPtools.exe -Destination dist/
        Copy-Item -Path README.md -Destination dist/
        Copy-Item -Path USAGE_GUIDE.md -Destination dist/
        Copy-Item -Path release/*.dll -Destination dist/ -ErrorAction SilentlyContinue
        Compress-Archive -Path dist/* -DestinationPath "$archName.zip"
    
    - name: Upload Artifact
      uses: actions/upload-artifact@v4
      with:
        name: IPtools-Windows-${{ matrix.mingw_arch }}
        path: IPtools-Windows-${{ matrix.mingw_arch }}.zip
        retention-days: 30

  build-linux:
    name: Build Linux (${{ matrix.arch }})
    runs-on: ubuntu-20.04
    strategy:
      fail-fast: false
      matrix:
        include:
          - arch: x86_64
            qt_arch: gcc_64
          - arch: aarch64
            qt_arch: gcc_64
    
    steps:
    - name: Checkout Code
      uses: actions/checkout@v4
    
    - name: Install Dependencies (x86_64)
      if: matrix.arch == 'x86_64'
      run: |
        sudo apt-get update
        sudo apt-get install -y qt5-default qtbase5-dev qttools5-dev-tools \
          build-essential lsof libgl1-mesa-dev
    
    - name: Install Cross-Compilation Tools (ARM64)
      if: matrix.arch == 'aarch64'
      run: |
        sudo apt-get update
        sudo apt-get install -y gcc-aarch64-linux-gnu g++-aarch64-linux-gnu \
          qt5-default qtbase5-dev qttools5-dev-tools build-essential
    
    - name: Build Project (x86_64)
      if: matrix.arch == 'x86_64'
      run: |
        qmake IPtools.pro CONFIG+=release
        make -j$(nproc)
    
    - name: Build Project (ARM64)
      if: matrix.arch == 'aarch64'
      run: |
        # Note: Full ARM64 cross-compilation requires ARM64 Qt libraries
        # This is a placeholder - actual cross-compilation needs proper Qt setup
        qmake IPtools.pro CONFIG+=release
        make -j$(nproc) CXX=aarch64-linux-gnu-g++ CC=aarch64-linux-gnu-gcc || echo "ARM64 cross-compilation requires ARM64 Qt libraries"
    
    - name: Create AppImage (x86_64)
      if: matrix.arch == 'x86_64'
      run: |
        sudo apt-get install -y libfuse2
        wget https://github.com/linuxdeploy/linuxdeploy/releases/download/continuous/linuxdeploy-x86_64.AppImage
        wget https://github.com/linuxdeploy/linuxdeploy-plugin-qt/releases/download/continuous/linuxdeploy-plugin-qt-x86_64.AppImage
        chmod +x linuxdeploy*.AppImage
        mkdir -p AppDir/usr/bin
        cp IPtools AppDir/usr/bin/
        cp README.md AppDir/usr/
        ./linuxdeploy-x86_64.AppImage --appdir AppDir --plugin qt --output appimage || echo "AppImage creation failed, continuing..."
    
    - name: Create Archive
      run: |
        mkdir -p dist
        if [ -f "IPtools" ]; then
          cp IPtools dist/
        fi
        cp README.md dist/ || true
        cp USAGE_GUIDE.md dist/ || true
        tar -czf IPtools-Linux-${{ matrix.arch }}.tar.gz -C dist .
    
    - name: Upload Artifact
      uses: actions/upload-artifact@v4
      with:
        name: IPtools-Linux-${{ matrix.arch }}
        path: |
          IPtools-Linux-${{ matrix.arch }}.tar.gz
          *.AppImage
        retention-days: 30

  build-macos:
    name: Build macOS (${{ matrix.arch }})
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: macos-12
            arch: x86_64
          - os: macos-14
            arch: arm64
    
    steps:
    - name: Checkout Code
      uses: actions/checkout@v4
    
    - name: Install Qt
      uses: jurplel/install-qt-action@v3
      with:
        version: ${{ env.QT_VERSION }}
        host: 'mac'
        target: 'desktop'
        modules: 'qtnetworkauth'
        cache: true
    
    - name: Build Project
      run: |
        qmake IPtools.pro CONFIG+=release
        make -j$(sysctl -n hw.ncpu)
    
    - name: Create App Bundle
      run: |
        mkdir -p dist
        cp -r IPtools.app dist/
        macdeployqt dist/IPtools.app -dmg
        cp README.md dist/ || true
        cp USAGE_GUIDE.md dist/ || true
    
    - name: Create Archive
      run: |
        cd dist
        if [ -f "IPtools.dmg" ]; then
          mv IPtools.dmg ../IPtools-macOS-${{ matrix.arch }}.dmg
        else
          tar -czf ../IPtools-macOS-${{ matrix.arch }}.tar.gz .
        fi
    
    - name: Upload Artifact
      uses: actions/upload-artifact@v4
      with:
        name: IPtools-macOS-${{ matrix.arch }}
        path: |
          IPtools-macOS-${{ matrix.arch }}.*
        retention-days: 30

  build-summary:
    name: Build Summary
    needs: [build-windows, build-linux, build-macos]
    runs-on: ubuntu-latest
    if: always()
    
    steps:
    - name: Summary
      run: |
        echo "## Build Results" >> $GITHUB_STEP_SUMMARY
        echo "| Platform | Status |" >> $GITHUB_STEP_SUMMARY
        echo "|----------|--------|" >> $GITHUB_STEP_SUMMARY
        echo "| Windows x64 | ${{ needs.build-windows.result }} |" >> $GITHUB_STEP_SUMMARY
        echo "| Windows x86 | ${{ needs.build-windows.result }} |" >> $GITHUB_STEP_SUMMARY
        echo "| Linux x86_64 | ${{ needs.build-linux.result }} |" >> $GITHUB_STEP_SUMMARY
        echo "| Linux ARM64 | ${{ needs.build-linux.result }} |" >> $GITHUB_STEP_SUMMARY
        echo "| macOS x86_64 | ${{ needs.build-macos.result }} |" >> $GITHUB_STEP_SUMMARY
        echo "| macOS ARM64 | ${{ needs.build-macos.result }} |" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "Build artifacts are available in the Actions tab." >> $GITHUB_STEP_SUMMARY

