name: Docker Cross-Platform Build

on:
  workflow_dispatch:
    inputs:
      architectures:
        description: 'Architectures to build (comma-separated: amd64,arm64,armv7)'
        required: true
        default: 'amd64,arm64'

jobs:
  docker-build:
    name: Docker Build (${{ matrix.arch }})
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        arch: [amd64, arm64, armv7]
    
    steps:
    - name: Checkout Code
      uses: actions/checkout@v4
    
    - name: Set up QEMU
      uses: docker/setup-qemu-action@v3
    
    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3
    
    - name: Create Dockerfile
      run: |
        cat > Dockerfile << 'EOF'
        FROM ubuntu:20.04 as builder
        
        ENV DEBIAN_FRONTEND=noninteractive
        ENV QT_VERSION=5.15.2
        
        # Install dependencies
        RUN apt-get update && apt-get install -y \
            qt5-default \
            qtbase5-dev \
            qttools5-dev-tools \
            build-essential \
            lsof \
            libgl1-mesa-dev \
            && rm -rf /var/lib/apt/lists/*
        
        WORKDIR /build
        COPY . .
        
        # Build
        RUN qmake IPtools.pro CONFIG+=release && \
            make -j$(nproc)
        
        # Create runtime image
        FROM ubuntu:20.04
        
        ENV DEBIAN_FRONTEND=noninteractive
        
        RUN apt-get update && apt-get install -y \
            libqt5core5a \
            libqt5gui5 \
            libqt5widgets5 \
            libqt5network5 \
            lsof \
            && rm -rf /var/lib/apt/lists/*
        
        COPY --from=builder /build/IPtools /usr/local/bin/
        COPY README.md /usr/share/doc/iptools/
        COPY USAGE_GUIDE.md /usr/share/doc/iptools/
        
        CMD ["/usr/local/bin/IPtools"]
        EOF
    
    - name: Build Docker Image
      if: contains(github.event.inputs.architectures, matrix.arch)
      run: |
        docker buildx build \
          --platform linux/${{ matrix.arch }} \
          --tag iptools:${{ matrix.arch }} \
          --load \
          .
    
    - name: Extract Binary
      if: contains(github.event.inputs.architectures, matrix.arch)
      run: |
        docker create --name temp iptools:${{ matrix.arch }}
        docker cp temp:/usr/local/bin/IPtools ./IPtools-${{ matrix.arch }}
        docker rm temp
        
        # Create archive
        mkdir -p dist
        cp IPtools-${{ matrix.arch }} dist/IPtools
        cp README.md dist/
        cp USAGE_GUIDE.md dist/
        tar -czf IPtools-Linux-${{ matrix.arch }}.tar.gz -C dist .
    
    - name: Upload Artifact
      if: contains(github.event.inputs.architectures, matrix.arch)
      uses: actions/upload-artifact@v5
      with:
        name: IPtools-Docker-${{ matrix.arch }}
        path: IPtools-Linux-${{ matrix.arch }}.tar.gz
        retention-days: 30

