name: Release Multi-Platform

on:
  push:
    tags:
      - 'v*.*.*'
  workflow_dispatch:
    inputs:
      version:
        description: 'Release version (e.g., v1.0.0)'
        required: true
        default: 'v1.0.0'

env:
  QT_VERSION: '5.15.2'

jobs:
  create-release:
    name: Create Release
    runs-on: ubuntu-latest
    outputs:
      upload_url: ${{ steps.create_release.outputs.upload_url }}
      version: ${{ steps.get_version.outputs.version }}
    
    steps:
    - name: Checkout Code
      uses: actions/checkout@v4
    
    - name: Get Version
      id: get_version
      run: |
        if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
          echo "version=${{ github.event.inputs.version }}" >> $GITHUB_OUTPUT
        else
          echo "version=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT
        fi
    
    - name: Create Release
      id: create_release
      uses: softprops/action-gh-release@v1
      with:
        tag_name: ${{ steps.get_version.outputs.version }}
        name: Release ${{ steps.get_version.outputs.version }}
        body: |
          ## IPtools ${{ steps.get_version.outputs.version }}
          
          ### ä¸‹è½½é“¾æŽ¥
          
          #### Windows
          - **Windows x64 (64ä½)**: `IPtools-${{ steps.get_version.outputs.version }}-windows-x64.zip`
          - **Windows x86 (32ä½)**: `IPtools-${{ steps.get_version.outputs.version }}-windows-x86.zip`
          
          #### Linux
          - **Linux x86_64**: `IPtools-${{ steps.get_version.outputs.version }}-linux-x86_64.tar.gz` æˆ– `IPtools-${{ steps.get_version.outputs.version }}-linux-x86_64.AppImage`
          - **Linux ARM64**: `IPtools-${{ steps.get_version.outputs.version }}-linux-arm64.tar.gz` (åŒ…å«äº¤å‰ç¼–è¯‘è¯´æ˜Ž)
          
          ### åŠŸèƒ½ç‰¹æ€§
          - âœ… æ–‡ä»¶å¥æŸ„æŸ¥è¯¢
          - âœ… è¿›ç¨‹ç®¡ç†
          - âœ… IPåœ°å€æŸ¥è¯¢
          
          ### å®‰è£…è¯´æ˜Ž
          
          **Windows**: è§£åŽ‹åŽç›´æŽ¥è¿è¡Œ `IPtools.exe` (å»ºè®®ä»¥ç®¡ç†å‘˜èº«ä»½è¿è¡Œ)
          
          **Linux**: 
          ```bash
          # ä½¿ç”¨ tar.gz
          tar -xzf IPtools-${{ steps.get_version.outputs.version }}-linux-x86_64.tar.gz
          chmod +x IPtools
          sudo ./IPtools
          
          # ä½¿ç”¨ AppImage
          chmod +x IPtools-${{ steps.get_version.outputs.version }}-linux-x86_64.AppImage
          ./IPtools-${{ steps.get_version.outputs.version }}-linux-x86_64.AppImage
          ```
          
          **macOS**: æ‰“å¼€ .dmg æ–‡ä»¶ï¼Œæ‹–æ‹½åˆ°åº”ç”¨ç¨‹åºæ–‡ä»¶å¤¹
          
          è¯¦ç»†ä½¿ç”¨è¯´æ˜Žè¯·æŸ¥çœ‹ [USAGE_GUIDE.md](https://github.com/${{ github.repository }}/blob/main/USAGE_GUIDE.md)
        draft: false
        prerelease: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  build-windows-release:
    name: Build Windows Release (${{ matrix.package_suffix }})
    needs: create-release
    runs-on: windows-latest
    strategy:
      fail-fast: false
      matrix:
        include:
          - arch: win64_mingw81
            mingw_arch: x86_64
            mingw_dir: mingw810_64
            qt_tool: qt.tools.win64_mingw810
            package_suffix: windows-x64
          - arch: win32_mingw81
            mingw_arch: i686
            mingw_dir: mingw810_32
            qt_tool: qt.tools.win32_mingw810
            package_suffix: windows-x86
    
    steps:
    - name: Checkout Code
      uses: actions/checkout@v4
    
    - name: Install Qt
      uses: jurplel/install-qt-action@v3
      with:
        version: ${{ env.QT_VERSION }}
        host: 'windows'
        target: 'desktop'
        arch: ${{ matrix.arch }}
        modules: 'qtnetworkauth'
        cache: true
        tools: "tools_mingw,${{ matrix.qt_tool }}"

    - name: Setup Build Environment
      shell: pwsh
      run: |
        if (-not $env:Qt5_Dir) {
          throw "Qt5_Dir çŽ¯å¢ƒå˜é‡æœªè®¾ç½®"
        }

        Write-Host "Qt5_Dir: $env:Qt5_Dir"
        Write-Host ""

        $qtBin = Join-Path $env:Qt5_Dir 'bin'
        if (Test-Path $qtBin) {
          Write-Host "Adding Qt bin: $qtBin"
          $qtBin | Out-File -FilePath $env:GITHUB_PATH -Encoding utf8 -Append
        }

        $qtVersionDir = Split-Path $env:Qt5_Dir -Parent
        $qtRoot = Split-Path $qtVersionDir -Parent

        $candidateToolsDirs = @(
          (Join-Path $qtRoot 'Tools'),
          'C:\\Qt\\Tools',
          (Join-Path $qtVersionDir 'Tools')
        )

        Write-Host "å€™é€‰ Qt Tools ç›®å½•ï¼š"
        $candidateToolsDirs | ForEach-Object { if ($_){ Write-Host "  - $_" } }

        $qtToolsRoot = $null
        foreach ($candidate in $candidateToolsDirs) {
          if ($candidate -and (Test-Path $candidate)) {
            $qtToolsRoot = $candidate
            break
          }
        }

        if (-not $qtToolsRoot) {
          throw "æœªæ‰¾åˆ° Qt Tools ç›®å½•ï¼Œå€™é€‰è·¯å¾„ï¼š$($candidateToolsDirs -join ', ')"
        }

        Write-Host "Qt Tools æ ¹ç›®å½•: $qtToolsRoot"

        $toolchainDir = Join-Path $qtToolsRoot '${{ matrix.mingw_dir }}'
        if (-not (Test-Path $toolchainDir)) {
          throw "æœªæ‰¾åˆ° Qt MinGW å·¥å…·é“¾ç›®å½•: $toolchainDir"
        }

        $mingwBin = Join-Path $toolchainDir 'bin'
        if (-not (Test-Path $mingwBin)) {
          throw "æœªæ‰¾åˆ° MinGW bin ç›®å½•: $mingwBin"
        }

        Write-Host "Using MinGW from Qt Tools: $mingwBin"
        $gccPath = Join-Path $mingwBin 'g++.exe'
        if (-not (Test-Path $gccPath)) {
          throw "g++.exe ä¸å­˜åœ¨äºŽ: $mingwBin"
        }

        $gccVersion = & $gccPath --version 2>&1 | Select-Object -First 1
        $gccTarget = & $gccPath -dumpmachine 2>&1
        Write-Host "  GCC Version: $gccVersion"
        Write-Host "  GCC Target: $gccTarget"

        if ($gccTarget -notlike "*${{ matrix.mingw_arch }}*") {
          throw "GCC ç›®æ ‡æž¶æž„ä¸åŒ¹é…ï¼ŒæœŸæœ›åŒ…å« ${{ matrix.mingw_arch }}ï¼Œå®žé™…ä¸º $gccTarget"
        }

        $mingwBin | Out-File -FilePath $env:GITHUB_PATH -Encoding utf8 -Append
        "MINGW_BIN=$mingwBin" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append

        Write-Host ""
        Write-Host "=== çŽ¯å¢ƒé…ç½®å®Œæˆ ==="
    
    - name: Build Project
      shell: cmd
      run: |
        echo Building IPtools...
        set "PATH=%MINGW_BIN%;%PATH%"
        "%Qt5_Dir%\bin\qmake.exe" IPtools.pro CONFIG+=release
        "%MINGW_BIN%\mingw32-make.exe" -j4
    
    - name: Deploy Qt Dependencies
      shell: cmd
      run: |
        echo Using Qt from %Qt5_Dir%
        set "PATH=%MINGW_BIN%;%PATH%"
        set QT_PLUGIN_PATH=%Qt5_Dir%\plugins
        set QML2_IMPORT_PATH=%Qt5_Dir%\qml
        echo QT_PLUGIN_PATH=%QT_PLUGIN_PATH%
        if not exist release (
          echo release ç›®å½•ä¸å­˜åœ¨
          exit /b 1
        )
        cd release
        "%Qt5_Dir%\bin\windeployqt.exe" IPtools.exe --release --no-translations --compiler-runtime --no-plugins
        if not exist platforms mkdir platforms
        copy "%Qt5_Dir%\plugins\platforms\qwindows.dll" platforms\ /Y
    
    - name: Prepare Release Package
      id: package
      shell: pwsh
      run: |
        $version = "${{ needs.create-release.outputs.version }}"
        $packageName = "IPtools-$version-${{ matrix.package_suffix }}"

        Remove-Item -Path $packageName -Recurse -Force -ErrorAction SilentlyContinue
        New-Item -ItemType Directory -Force -Path $packageName | Out-Null

        Copy-Item -Path 'release\*' -Destination $packageName -Recurse -Force
        Copy-Item -Path README.md -Destination $packageName/ -ErrorAction SilentlyContinue
        Copy-Item -Path USAGE_GUIDE.md -Destination $packageName/ -ErrorAction SilentlyContinue
        Copy-Item -Path CHANGELOG.md -Destination $packageName/ -ErrorAction SilentlyContinue
        Copy-Item -Path LICENSE -Destination $packageName/ -ErrorAction SilentlyContinue

        Compress-Archive -Path "$packageName/*" -DestinationPath "$packageName.zip"
        "asset_path=$packageName.zip" | Out-File -FilePath $env:GITHUB_OUTPUT -Encoding utf8 -Append
        "asset_name=$packageName.zip" | Out-File -FilePath $env:GITHUB_OUTPUT -Encoding utf8 -Append
    
    - name: Upload Release Asset
      uses: softprops/action-gh-release@v1
      with:
        tag_name: ${{ needs.create-release.outputs.version }}
        files: ${{ steps.package.outputs.asset_path }}
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  build-linux-release:
    name: Build Linux Release (${{ matrix.platform_name }})
    needs: create-release
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        include:
          - arch: x86_64
            platform_name: linux-x86_64
            build_appimage: true
          - arch: aarch64
            platform_name: linux-arm64
            cross_compile: true
    
    steps:
    - name: Checkout Code
      uses: actions/checkout@v4
    
    - name: Install Dependencies (x86_64)
      if: matrix.arch == 'x86_64'
      env:
        DEBIAN_FRONTEND: noninteractive
      run: |
        sudo rm -rf /var/lib/apt/lists/*
        sudo apt-get update
        sudo apt-get install -y --no-install-recommends qtbase5-dev qttools5-dev-tools build-essential lsof libgl1-mesa-dev libfuse2

    - name: Install Additional Qt Tools (x86_64)
      if: matrix.arch == 'x86_64'
      env:
        DEBIAN_FRONTEND: noninteractive
      run: |
        sudo snap install qt515core20 --classic || true
        sudo apt-get install -y --no-install-recommends qt5-image-formats-plugins qt5-qmake qttools5-dev

    - name: Install Dependencies (ARM64)
      if: matrix.arch == 'aarch64'
      env:
        DEBIAN_FRONTEND: noninteractive
      run: |
        sudo rm -rf /var/lib/apt/lists/*
        sudo apt-get update
        sudo apt-get install -y --no-install-recommends gcc-aarch64-linux-gnu g++-aarch64-linux-gnu qtbase5-dev qttools5-dev-tools build-essential
        echo "ARM64 äº¤å‰ç¼–è¯‘çŽ¯å¢ƒå·²å®‰è£…"
    
    - name: Build Project
      if: matrix.arch == 'x86_64'
      run: |
        qmake IPtools.pro CONFIG+=release
        make -j$(nproc)
    
    - name: Build Project (ARM64 æ ¡éªŒ)
      if: matrix.arch == 'aarch64'
      run: |
        echo "æ³¨æ„ï¼šARM64 ä»…è¿›è¡Œæºç ç¼–è¯‘éªŒè¯ï¼Œä¸ç”Ÿæˆå¯æ‰§è¡Œæ–‡ä»¶"
        aarch64-linux-gnu-g++ --version
        echo "ARM64 ç¼–è¯‘å™¨éªŒè¯å®Œæˆ"
        exit 0

    - name: Create AppImage
      if: matrix.arch == 'x86_64' && matrix.build_appimage
      run: |
        wget https://github.com/linuxdeploy/linuxdeploy/releases/download/continuous/linuxdeploy-x86_64.AppImage
        wget https://github.com/linuxdeploy/linuxdeploy-plugin-qt/releases/download/continuous/linuxdeploy-plugin-qt-x86_64.AppImage
        chmod +x linuxdeploy*.AppImage
        mkdir -p AppDir/usr/bin AppDir/usr/share/applications AppDir/usr/share/icons/hicolor/256x256/apps
        cp IPtools AppDir/usr/bin/
        
        # Create desktop file
        cat > AppDir/usr/share/applications/iptools.desktop << EOF
        [Desktop Entry]
        Type=Application
        Name=IPtools
        Comment=IP and System Tools
        Exec=IPtools
        Icon=iptools
        Categories=Utility;Network;
        Terminal=false
        EOF
        
        # Use a default icon (you can add your own icon file)
        touch AppDir/usr/share/icons/hicolor/256x256/apps/iptools.png
        
        export VERSION=${{ needs.create-release.outputs.version }}
        ./linuxdeploy-x86_64.AppImage --appdir AppDir --plugin qt --output appimage || echo "AppImage creation failed, continuing..."
        if [ -f "IPtools-x86_64.AppImage" ]; then
          mv IPtools-x86_64.AppImage IPtools-${{ needs.create-release.outputs.version }}-linux-x86_64.AppImage
        fi
    
    - name: Create Release Archive (x86_64)
      if: matrix.arch == 'x86_64'
      run: |
        version="${{ needs.create-release.outputs.version }}"
        archName="IPtools-$version-linux-x86_64"
        mkdir -p $archName
        cp IPtools $archName/
        cp README.md $archName/
        cp USAGE_GUIDE.md $archName/
        cp CHANGELOG.md $archName/
        cp LICENSE $archName/ || true
        tar -czf $archName.tar.gz $archName
    
    - name: Create Placeholder Archive (ARM64)
      if: matrix.arch == 'aarch64'
      run: |
        version="${{ needs.create-release.outputs.version }}"
        archName="IPtools-$version-linux-arm64"
        mkdir -p dist
        cat <<'EOF' > dist/README.txt
        ARM64 äº¤å‰ç¼–è¯‘è¯´æ˜Žï¼š
        è¯¥ç‰ˆæœ¬ä»…å®Œæˆæºç ç¼–è¯‘éªŒè¯ï¼Œå¦‚éœ€å¯è¿è¡Œçš„äºŒè¿›åˆ¶ï¼Œè¯·åœ¨ ARM64 çŽ¯å¢ƒæ‰‹åŠ¨æž„å»ºã€‚

        æŽ¨èæ­¥éª¤ï¼š
        1. sudo apt-get install qt5-default qtbase5-dev build-essential
        2. qmake IPtools.pro CONFIG+=release
        3. make -j$(nproc)
        EOF
        cp README.md dist/ || true
        cp USAGE_GUIDE.md dist/ || true
        cp CHANGELOG.md dist/ || true
        cp LICENSE dist/ || true
        tar -czf "$archName.tar.gz" -C dist .

    - name: Upload Release Assets (x86_64)
      if: matrix.arch == 'x86_64'
      uses: softprops/action-gh-release@v1
      with:
        tag_name: ${{ needs.create-release.outputs.version }}
        files: |
          IPtools-${{ needs.create-release.outputs.version }}-linux-x86_64.tar.gz
          IPtools-${{ needs.create-release.outputs.version }}-linux-x86_64.AppImage
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

    - name: Upload Release Assets (ARM64)
      if: matrix.arch == 'aarch64'
      uses: softprops/action-gh-release@v1
      with:
        tag_name: ${{ needs.create-release.outputs.version }}
        files: IPtools-${{ needs.create-release.outputs.version }}-linux-arm64.tar.gz
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  release-summary:
    name: Release Summary
    needs: [create-release, build-windows-release, build-linux-release]
    runs-on: ubuntu-latest
    if: always()
    
    steps:
    - name: Summary
      run: |
        echo "## Release ${{ needs.create-release.outputs.version }}" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### Build Status" >> $GITHUB_STEP_SUMMARY
        echo "| å¹³å° | æž¶æž„ | çŠ¶æ€ |" >> $GITHUB_STEP_SUMMARY
        echo "|------|------|------|" >> $GITHUB_STEP_SUMMARY
        echo "| ðŸªŸ Windows | x64 | ${{ needs.build-windows-release.result }} |" >> $GITHUB_STEP_SUMMARY
        echo "| ðŸªŸ Windows | x86 | ${{ needs.build-windows-release.result }} |" >> $GITHUB_STEP_SUMMARY
        echo "| ðŸ§ Linux | x86_64 | ${{ needs.build-linux-release.result }} |" >> $GITHUB_STEP_SUMMARY
        echo "| ðŸ§ Linux | ARM64 | ${{ needs.build-linux-release.result }} |" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "Release page: https://github.com/${{ github.repository }}/releases/tag/${{ needs.create-release.outputs.version }}" >> $GITHUB_STEP_SUMMARY

