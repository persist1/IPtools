name: Release Multi-Platform

on:
  push:
    tags:
      - 'v*.*.*'
  workflow_dispatch:
    inputs:
      version:
        description: 'Release version (e.g., v1.0.0)'
        required: true
        default: 'v1.0.0'

env:
  QT_VERSION: '5.15.2'

jobs:
  create-release:
    name: Create Release
    runs-on: ubuntu-latest
    outputs:
      upload_url: ${{ steps.create_release.outputs.upload_url }}
      version: ${{ steps.get_version.outputs.version }}
    
    steps:
    - name: Checkout Code
      uses: actions/checkout@v4
    
    - name: Get Version
      id: get_version
      run: |
        if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
          echo "version=${{ github.event.inputs.version }}" >> $GITHUB_OUTPUT
        else
          echo "version=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT
        fi
    
    - name: Create Release
      id: create_release
      uses: softprops/action-gh-release@v1
      with:
        tag_name: ${{ steps.get_version.outputs.version }}
        name: Release ${{ steps.get_version.outputs.version }}
        body: |
          ## IPtools ${{ steps.get_version.outputs.version }}
          
          ### 下载链接
          
          #### Windows
          - **Windows x64 (64位)**: `IPtools-Windows-x86_64.zip`
          - **Windows x86 (32位)**: `IPtools-Windows-i686.zip`
          
          #### Linux
          - **Linux x86_64**: `IPtools-Linux-x86_64.tar.gz` 或 `IPtools-x86_64.AppImage`
          - **Linux ARM64**: `IPtools-Linux-aarch64.tar.gz` (树莓派4、ARM服务器)
          
          #### macOS
          - **macOS Intel**: `IPtools-macOS-x86_64.dmg`
          - **macOS Apple Silicon**: `IPtools-macOS-arm64.dmg`
          
          ### 功能特性
          - ✅ 文件句柄查询
          - ✅ 进程管理
          - ✅ IP地址查询
          
          ### 安装说明
          
          **Windows**: 解压后直接运行 `IPtools.exe` (建议以管理员身份运行)
          
          **Linux**: 
          ```bash
          # 使用 tar.gz
          tar -xzf IPtools-Linux-x86_64.tar.gz
          chmod +x IPtools
          sudo ./IPtools
          
          # 使用 AppImage
          chmod +x IPtools-x86_64.AppImage
          ./IPtools-x86_64.AppImage
          ```
          
          **macOS**: 打开 .dmg 文件，拖拽到应用程序文件夹
          
          详细使用说明请查看 [USAGE_GUIDE.md](https://github.com/${{ github.repository }}/blob/main/USAGE_GUIDE.md)
        draft: false
        prerelease: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  build-windows-release:
    name: Build Windows Release (${{ matrix.arch }})
    needs: create-release
    runs-on: windows-latest
    strategy:
      fail-fast: false
      matrix:
        include:
          - arch: win64_mingw81
            mingw_arch: x86_64
            mingw_prefix: mingw64
          - arch: win32_mingw81
            mingw_arch: i686
            mingw_prefix: mingw32
    
    steps:
    - name: Checkout Code
      uses: actions/checkout@v4
    
    - name: Install Qt
      uses: jurplel/install-qt-action@v3
      with:
        version: ${{ env.QT_VERSION }}
        host: 'windows'
        target: 'desktop'
        arch: ${{ matrix.arch }}
        modules: 'qtnetworkauth'
        cache: true
    
    - name: Build Project
      shell: cmd
      run: |
        qmake IPtools.pro CONFIG+=release
        mingw32-make -j4
    
    - name: Deploy Qt Dependencies
      shell: cmd
      run: |
        cd release
        windeployqt IPtools.exe --release --no-translations
    
    - name: Create Release Package
      shell: pwsh
      run: |
        $version = "${{ needs.create-release.outputs.version }}"
        $archName = "IPtools-$version-Windows-${{ matrix.mingw_arch }}"
        New-Item -ItemType Directory -Force -Path $archName
        Copy-Item -Path release/IPtools.exe -Destination $archName/
        Copy-Item -Path README.md -Destination $archName/
        Copy-Item -Path USAGE_GUIDE.md -Destination $archName/
        Copy-Item -Path CHANGELOG.md -Destination $archName/
        Copy-Item -Path release/*.dll -Destination $archName/ -ErrorAction SilentlyContinue
        Compress-Archive -Path $archName/* -DestinationPath "$archName.zip"
    
    - name: Upload Release Asset
      uses: softprops/action-gh-release@v1
      with:
        tag_name: ${{ needs.create-release.outputs.version }}
        files: IPtools-*-Windows-*.zip
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  build-linux-release:
    name: Build Linux Release (x86_64)
    needs: create-release
    runs-on: ubuntu-20.04
    
    steps:
    - name: Checkout Code
      uses: actions/checkout@v4
    
    - name: Install Dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y qt5-default qtbase5-dev qttools5-dev-tools \
          build-essential lsof libgl1-mesa-dev libfuse2
    
    - name: Build Project
      run: |
        qmake IPtools.pro CONFIG+=release
        make -j$(nproc)
    
    - name: Create AppImage
      run: |
        wget -q https://github.com/linuxdeploy/linuxdeploy/releases/download/continuous/linuxdeploy-x86_64.AppImage
        wget -q https://github.com/linuxdeploy/linuxdeploy-plugin-qt/releases/download/continuous/linuxdeploy-plugin-qt-x86_64.AppImage
        chmod +x linuxdeploy*.AppImage
        mkdir -p AppDir/usr/bin AppDir/usr/share/applications AppDir/usr/share/icons/hicolor/256x256/apps
        cp IPtools AppDir/usr/bin/
        
        # Create desktop file
        cat > AppDir/usr/share/applications/iptools.desktop << EOF
        [Desktop Entry]
        Type=Application
        Name=IPtools
        Comment=IP and System Tools
        Exec=IPtools
        Icon=iptools
        Categories=Utility;Network;
        Terminal=false
        EOF
        
        # Use a default icon (you can add your own icon file)
        touch AppDir/usr/share/icons/hicolor/256x256/apps/iptools.png
        
        export VERSION=${{ needs.create-release.outputs.version }}
        ./linuxdeploy-x86_64.AppImage --appdir AppDir --plugin qt --output appimage || true
    
    - name: Create Tar Archive
      run: |
        version="${{ needs.create-release.outputs.version }}"
        archName="IPtools-$version-Linux-x86_64"
        mkdir -p $archName
        cp IPtools $archName/
        cp README.md $archName/
        cp USAGE_GUIDE.md $archName/
        cp CHANGELOG.md $archName/
        tar -czf $archName.tar.gz $archName
    
    - name: Upload Release Assets
      uses: softprops/action-gh-release@v1
      with:
        tag_name: ${{ needs.create-release.outputs.version }}
        files: |
          IPtools-*-Linux-x86_64.tar.gz
          IPtools-*.AppImage
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  build-macos-release:
    name: Build macOS Release (${{ matrix.arch }})
    needs: create-release
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: macos-12
            arch: x86_64
          - os: macos-14
            arch: arm64
    
    steps:
    - name: Checkout Code
      uses: actions/checkout@v4
    
    - name: Install Qt
      uses: jurplel/install-qt-action@v3
      with:
        version: ${{ env.QT_VERSION }}
        host: 'mac'
        target: 'desktop'
        modules: 'qtnetworkauth'
        cache: true
    
    - name: Build Project
      run: |
        qmake IPtools.pro CONFIG+=release
        make -j$(sysctl -n hw.ncpu)
    
    - name: Create DMG
      run: |
        mkdir -p dist
        cp -r IPtools.app dist/
        macdeployqt dist/IPtools.app -dmg
        version="${{ needs.create-release.outputs.version }}"
        mv dist/IPtools.dmg IPtools-$version-macOS-${{ matrix.arch }}.dmg
    
    - name: Upload Release Asset
      uses: softprops/action-gh-release@v1
      with:
        tag_name: ${{ needs.create-release.outputs.version }}
        files: IPtools-*-macOS-*.dmg
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  release-summary:
    name: Release Summary
    needs: [create-release, build-windows-release, build-linux-release, build-macos-release]
    runs-on: ubuntu-latest
    if: always()
    
    steps:
    - name: Summary
      run: |
        echo "## Release ${{ needs.create-release.outputs.version }}" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### Build Status" >> $GITHUB_STEP_SUMMARY
        echo "| Platform | Status |" >> $GITHUB_STEP_SUMMARY
        echo "|----------|--------|" >> $GITHUB_STEP_SUMMARY
        echo "| Windows | ${{ needs.build-windows-release.result }} |" >> $GITHUB_STEP_SUMMARY
        echo "| Linux | ${{ needs.build-linux-release.result }} |" >> $GITHUB_STEP_SUMMARY
        echo "| macOS | ${{ needs.build-macos-release.result }} |" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "Release page: https://github.com/${{ github.repository }}/releases/tag/${{ needs.create-release.outputs.version }}" >> $GITHUB_STEP_SUMMARY

